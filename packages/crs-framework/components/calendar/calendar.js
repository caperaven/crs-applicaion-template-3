import{CalendarUtils as r}from"./calendar-utils.js";import{CalendarKeyboardInputManager as c}from"./managers/calendar-keyboard-input-manager.js";class o extends crs.classes.BindableElement{#t;#e;#h;#i;#S;#n;#l;#o;#r={yearsVisualSelection:this.#P.bind(this),monthsVisualSelection:this.#m.bind(this),defaultVisualSelection:this.#w.bind(this)};#c={goToPrevious:this.goToPrevious.bind(this),goToNext:this.goToNext.bind(this),selectView:this.#q.bind(this),selectedDate:this.selectedDate.bind(this)};get shadowDom(){return!0}get selectedView(){return this.getProperty("selectedView")}get html(){return import.meta.url.replace(".js",".html")}static get observedAttributes(){return["data-start"]}async preLoad(){this.setProperty("folder",import.meta.url.replace("/calendar.js","/templates")),this.setProperty("selectedView","default"),await this.#s(),await this.#a()}async load(){this.#l=this.shadowRoot.querySelector("#perspectiveElement"),this.#o=this.#T.bind(this),this.#l.addEventListener("view-loaded",this.#o);const t=this.shadowRoot.querySelector("#tplCell");await crs.binding.inflation.manager.register("calendar-cell",t);const e=this.shadowRoot.querySelector("#tplYears");await crs.binding.inflation.manager.register("calendar-years",e),this.#h=new c(this),this.#i=this.#x.bind(this),this.addEventListener("change-month",this.#i),this.#n=this.#k.bind(this),this.addEventListener("click",this.#n)}async disconnectedCallback(){await crs.binding.inflation.manager.unregister("calendar-cell"),await crs.binding.inflation.manager.unregister("calendar-years"),this.removeEventListener("change-month",this.#i),this.#t=null,this.#e=null,this.#S=null,await this.#v(this.#r),this.#r=null,this.#h=this.#h.dispose(),this.#i=null,await this.#v(this.#c),this.#c=null,this.removeEventListener("click",this.#n),this.#n=null,this.#l.removeEventListener("view-loaded",this.#o),this.#l=null,this.#o=null,await super.disconnectedCallback()}async attributeChangedCallback(t,e,s){if(s==null)return;const a=new Date(s);this.#t=a.getMonth(),this.#e=a.getFullYear(),await this.#s(),await this.#a(),s!==e&&await this.#w()}async#d(){if(this.calendars==null)return;const t=await crs.call("date","get_days",{month:this.#t,year:this.#e,only_current:!1}),e=this.shadowRoot.querySelectorAll("[role='cell']");await crs.binding.inflation.manager.get("calendar-cell",t,e),await this.#p(),await this.#f()}async#D(){const t=new Date().getFullYear(),e=r.getYearsAround(t,-30,30),s=this.shadowRoot.querySelectorAll("[data-type='year-cell']");await crs.binding.inflation.manager.get("calendar-years",e,s);const a=await this.#u(this.#e);a.scrollIntoView({block:"start",behavior:"smooth"}),a.focus()}async#s(){this.setProperty("selectedMonthText",new Date(this.#e,this.#t).toLocaleString(navigator.language,{month:"long"})),this.setProperty("selectedMonth",this.#t),this.selectedView==="months"&&await this.#m()}async#a(){this.setProperty("selectedYearText",this.#e),this.setProperty("selectedYear",this.#e)}async#u(t){const e=this.shadowRoot.querySelector(`[data-value = '${t}']`);return await crs.call("dom_collection","toggle_selection",{target:e,multiple:!1}),e.setAttribute("tabindex","0"),e}async#y(){this.setProperty("selectedView","default")}async#P(){requestAnimationFrame(async()=>await this.#D())}async#m(){(await this.#u(this.#t)).focus()}async#w(){requestAnimationFrame(async()=>{await this.#d()})}async#T(){const t=this.selectedView;this.#r[`${t}VisualSelection`]&&await this.#r[`${t}VisualSelection`]()}async selectedMonthChanged(t){t!==this.#t&&t!=null&&(this.#t=Number.parseInt(t)>11?parseInt(this.#t):t,await this.#s(),t!=null&&await this.#y())}async selectedYearChanged(t){t!==this.#e&&t!=null&&(this.#e=t.toString().length<4?parseInt(this.#e):t,await this.#a(),t!=null&&await this.#y())}async selectedDate(t,e){e.getAttribute("role")==="cell"&&(await this.#A(e),await this.#g(e),this.dispatchEvent(new CustomEvent("date-selected",{bubbles:!0,composed:!0,detail:{date:this.dataset.start}})),await this.#p(e),await this.#f())}async#x(t){const e=t.detail;if(await this.#g(e),e.classList[0]==="non-current-day"){const s=parseInt(e.dataset.month),a=parseInt(e.dataset.year);this.#t>s&&this.#e<a?await this.goToNext():this.#t<s&&this.#e>a?await this.goToPrevious():this.#t>s?await this.goToPrevious():await this.goToNext()}t.stopPropagation()}async#A(t){const e=new Date(new Date(t.dataset.year,t.dataset.month,t.dataset.day).getTime()-new Date().getTimezoneOffset()*60*1e3);this.setAttribute("data-start",e.toISOString().slice(0,10))}async#g(t){const e=new Date(new Date(t.dataset.year,t.dataset.month,t.dataset.day).getTime()-new Date().getTimezoneOffset()*60*1e3);this.calendars?.setAttribute("data-position",e.toISOString().slice(0,10))}async#f(){const t=this.calendars?.querySelectorAll("[tabindex='0']"),e=this.calendars?.querySelector("[aria-selected='true']"),s=this.calendars?.querySelector(".today"),a=await this.#b(this.calendars?.dataset.position),n=this.calendars?.querySelector("[data-day='1']:not([class = '.non-current-day'])");await this.#E(t);const i=[{condition:e==null&&s!=null&&a==null,element:s},{condition:e==null&&s==null&&a==null,element:n},{condition:e!=null&&s==null&&a==null,element:e},{condition:e!=null&&s!=null&&a==null,element:e},{condition:e!=null&&s!=null&&a!=null,element:a,tabIndex:-1},{condition:e==null&&s==null&&a!=null,element:a},{condition:e==null&&s!=null&&a!=null,element:a},{condition:e!=null&&s==null&&a!=null,element:a}];for(const l of i)if(l.condition){await this.#I(l.element,l.tabIndex);break}}async#I(t,e){t!=null&&(t.tabIndex=0,t.focus())}async#E(t){if(t!=null)for(const e of t)e.tabIndex=-1}async#p(){const t=await this.#b(this.dataset.start);t!=null&&await crs.call("dom_collection","toggle_selection",{target:t,multiple:!1})}async#b(t){if(t==null)return;const e=new Date(t),s=e.getFullYear(),a=e.getMonth(),n=e.getDate(),i=this.calendars?.querySelector(`[data-day= '${n}'][data-month= '${a}'][data-year= '${s}']`);return i||null}async#k(t){const e=t.composedPath()[0],s=e.dataset.action||e.parentElement?.dataset.action;s!=null&&this.#c[s]!=null&&await this.#c[s](t,e)}async#q(t,e){const a={default:{month:"months",year:"years"},months:{year:"years"},years:{month:"months"}}[this.selectedView]?.[e.id]||"default";this.setProperty("selectedView",a)}async goToNext(){this.selectedView==="years"?this.#e++:(this.#t++,this.#t>11&&(this.#t=0,this.#e++)),await this.#s(),await this.#a(),await this.#d()}async goToPrevious(){this.selectedView==="years"?this.#e--:(this.#t--,this.#t<0&&(this.#t=11,this.#e--)),await this.#s(),await this.#a(),await this.#d()}async#v(t){for(const e of Object.keys(t))t[e]=null}}customElements.define("calendar-component",o);export{o as default};
